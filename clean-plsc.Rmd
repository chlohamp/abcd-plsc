---
title: "ABCD-PLSC-Ap-GM-Rscript"
author:"Chloe Hampson, Taylor Jancetic, Kirthana"
date: "2024-09-30"
output:
  html_document:
    fontsize : 9 pt
    theme: united
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 6
---

## Import Libraries
```{r}
rm(list = ls()) # Clear environment
graphics.off() # Clear all plots

# Load necessary libraries
library(tidyverse) # Core tidyverse packages
library(ExPosition) # Multivariate data analysis
library(TExPosition) # Tensor-based ExPosition analysis
# library(TInPosition)  # Uncomment if needed and installed
library(PTCA4CATA) # Permutation Tests for CATA
library(data4PCCAR) # Example datasets for PCA
library(plyr) # Data manipulation (load first to avoid conflicts)
library(dplyr) # Data manipulation
library(corrplot) # Correlation plots
library(ggplot2) # Data visualization
library(cowplot) # Plot arrangement
library(readr) # Reading data files
library(gridExtra) # Arrange grid-based visualizations
library(grid) # Low-level graphics system
library(here) # Relative file paths
library(psych) # Psychometric tools
library(car)
library(kableExtra)
```


**Data :**  cleaned data, pre processed and grouped into two different datasets - one for RSI measures and other for sociocultural measures from ABCD data.

```{r}
# load datasets
covar_df <- read_csv("/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/covariate.csv")
socio_df <- read_csv("/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/clean-socio.csv")
rsfc_df <- read_csv("/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/clean-rsfc.csv")


fig_dir <- "/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/figures/"
out_dir <- "/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced"


```

## Performing residualization 

###  MLRM for resting-state data

```{r}
## resting state variables and covariates
# dependent variables
Group1.Y <- as.matrix(rsfc_df)
View(Group1.Y)

# independent variables/covariates
Group1.X <- covar_df
View(Group1.X)
```



```{r}
# Multiple regression model
lm.Group1 <- lm(Group1.Y ~ Group1.X$interview_age +
  as.factor(Group1.X$demo_sex_v2) +
  Group1.X$demo_prnt_age_v2 +
  as.factor(Group1.X$demo_prnt_gender_id_v2) +
  Group1.X$demo_prnt_ed_v2_2yr_l +
  Group1.X$demo_prtnr_ed_v2_2yr_l +
  Group1.X$demo_comb_income_v2 +
  as.factor(Group1.X$demo_origin_v2) +
  as.factor(Group1.X$site_id_l) +
  as.factor(Group1.X$mri_info_manufacturer) +
  Group1.X$rsfmri_meanmotion, na.action = na.omit)


# R.square -> how well the model explains the variation in the data which is not random
# Theorotical model performace is defined as R square

Group1_residuals <- data.frame()
Group1_residuals <- as.data.frame(lm.Group1$residuals)
```

### MLRM for sociocultural data

```{r echo=TRUE}
Group2.Y <- as.matrix(socio_df)


lm.Group2 <- lm(Group2.Y ~ Group1.X$interview_age +
  as.factor(Group1.X$demo_sex_v2) +
  Group1.X$demo_prnt_age_v2 +
  as.factor(Group1.X$demo_prnt_gender_id_v2) +
  Group1.X$demo_prnt_ed_v2_2yr_l +
  Group1.X$demo_prtnr_ed_v2_2yr_l +
  Group1.X$demo_comb_income_v2 +
  as.factor(Group1.X$demo_origin_v2) +
  as.factor(Group1.X$site_id_l) +
  as.factor(Group1.X$mri_info_manufacturer) +
  Group1.X$rsfmri_meanmotion, na.action = na.omit)

# keep if we decide this is how we want to deal with missing data #,na.action = na.omit)
# Run VIF to check for multicollinearity
summary(lm.Group2)

Group2_residuals <- data.frame()
Group2_residuals <- as.data.frame(lm.Group2$residuals)

```


## PLSC Analysis


```{r}
# Input data for PLSC
data1 <- as.data.frame(Group1_residuals)
data2 <- as.data.frame(Group2_residuals)

```



```{r echo=TRUE}
# Extract design variable and ensure it's a factor (nominal)
data.design <- as.factor(covar_df$site_id_l)

# Convert to a matrix for PLSC input
data.design.vec <- as.matrix(data.design)
rownames(data.design.vec) <- covar_df$src_subject_id

# Run PLSC analysis
pls.res <- tepPLS(
  data1,
  data2,
  DESIGN = data.design.vec,
  make_design_nominal = TRUE,
  graphs = FALSE
)

summary(pls.res)
```


```{r}
# generating bar plots for loadings of Air pollutants data table
Q.data2 <- pls.res$TExPosition.Data$pdq$q
# generating bar plots for loadings of RSI data table
P.data1 <- pls.res$TExPosition.Data$pdq$p

# saving the loading table into excel file.
socio_loadings <- as.data.frame(Q.data2)
rest_loadings <- as.data.frame(P.data1)
```
```{r}
# Looking into what the resBootPLSC is giving us
resBoot4PLSC <- Boot4PLSC(data1, # First Data matrix
  data2, # Second Data matrix
  nIter = 10000, # How many iterations
  Fi = pls.res$TExPosition.Data$fi,
  Fj = pls.res$TExPosition.Data$fj,
  nf2keep = 5, #determines number of dimensions that go into bootstrap
  critical.value = 2.5,
  # To be implemented later
  # has no effect currently
  alphaLevel = 0.5
)

resBoot4PLSC

```

```{r}

BR.I <- resBoot4PLSC$bootRatios.i
BR.J <- resBoot4PLSC$bootRatios.j

```


```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 1 and 3
for (dim in c(1, 3)) {
  # Save the plot for BR.I
  png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRI_Dim", dim, ".png")), 
      width = 2000, height = 1200, res = 200)

  # For brain networks, use black for significant bars and grey for non-significant
  significant_idx <- abs(BR.I[, dim]) >= 3
  cols_I <- ifelse(significant_idx, "black", "grey70")

  plot_BRI <- PrettyBarPlot2(BR.I[, dim],
    threshold = 3,
    font.size = 3,
    ylab = "Bootstrap ratios",
    color4bar = cols_I,
  ) + ggtitle(paste0("Component ", dim), subtitle = "Brain Networks (RSFC)")

  print(plot_BRI)
  dev.off() # Close the PNG device for BR.I

  cat("✓ Saved bootstrap ratio plot for Brain Networks, Dimension", dim, "\n")
}

```


```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 1 
dim <- 1  # Change this to plot different dimensions

# Define colors for significant variables
dim1_colors <- c(
  "COI" = "#71C0E7",
  "NDI" = "#9BF1FE"
)

# Create color vector with grey default
build_row_colors <- function(rows, palette, default = "grey70") {
  col_vec <- setNames(rep(default, length(rows)), rows)
  # Only color the bars that are both in our color palette AND exceed the threshold of |3|
  BR_values <- if(identical(rows, rownames(BR.I))) {
    BR.I[, dim]
  } else {
    BR.J[, dim]
  }
  significant_idx <- abs(BR_values) >= 3  # Values >= +3 or <= -3 are significant
  common <- intersect(names(palette), rows[significant_idx])
  col_vec[common] <- palette[common]
  unname(col_vec)
}

# Save the plot for BR.J
png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRJ_Dim", dim, ".png")), 
    width = 2000, height = 1200, res = 200)


# Apply colors only to significant bars
cols_J <- build_row_colors(rownames(BR.J), dim1_colors)
  
plot_BRJ <- PrettyBarPlot2(BR.J[, dim],
  threshold = 3,
  font.size = 4,
  ylab = "Bootstrap ratios",
  color4bar = cols_J,
) + ggtitle(paste0("Component ", dim), subtitle = "Sociocultural Variables") 
  
print(plot_BRJ)
dev.off() # Close the PNG device for BR.J
  
cat("✓ Saved bootstrap ratio plots for Dimension", dim, "\n\n")

```


```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 3
dim <- 3  # Change this to plot different dimensions

# Define colors for significant variables for dimension 3
dim3_colors <- c(
  "EIE-C" = "#90CEC1",
  "FO-C" = "#90CEC1",
  "FS-Y" = "#90CEC1",
  "EIC-C" = "#BCE3C8",
  "FR-C" = "#BCE3C8",
  "HA-C" = "#D2F3D8",
  "FR-Y" = "#D2F3D8"
)

# Create color vector with grey default
build_row_colors <- function(rows, palette, default = "grey70") {
  col_vec <- setNames(rep(default, length(rows)), rows)
  # Only color the bars that are both in our color palette AND exceed the threshold of |3|
  BR_values <- if(identical(rows, rownames(BR.I))) {
    BR.I[, dim]
  } else {
    BR.J[, dim]
  }
  significant_idx <- abs(BR_values) >= 3  # Values >= +3 or <= -3 are significant
  common <- intersect(names(palette), rows[significant_idx])
  col_vec[common] <- palette[common]
  unname(col_vec)
}
```

```{r echo=TRUE}
# Save the plot for BR.J
png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRJ_Dim", dim, ".png")), 
    width = 2000, height = 1200, res = 200)

# Apply colors only to significant bars
cols_J <- build_row_colors(rownames(BR.J), dim3_colors)  # Use dim3_colors instead of dim1_colors
  
plot_BRJ <- PrettyBarPlot2(BR.J[, dim],
  threshold = 3,
  font.size = 4,
  ylab = "Bootstrap ratios",
  color4bar = cols_J,
  color4ns = "grey70"
) + ggtitle(paste0("Component ", dim), subtitle = "Sociocultural Variables")
  
print(plot_BRJ)
dev.off() # Close the PNG device for BR.J
  
cat("✓ Saved bootstrap ratio plots for Dimension", dim, "\n\n")

```
