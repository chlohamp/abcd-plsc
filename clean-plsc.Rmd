---
title: "ABCD-PLSC-Ap-GM-Rscript"
author:"Chloe Hampson, Taylor Jancetic, Kirthana"
date: "2024-09-30"
output:
  html_document:
    fontsize : 9 pt
    theme: united
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 6
---

## Import Libraries
```{r}
rm(list = ls()) # Clear environment
graphics.off() # Clear all plots

# Load necessary libraries
library(tidyverse) # Core tidyverse packages
library(ExPosition) # Multivariate data analysis
library(TExPosition) # Tensor-based ExPosition analysis
# library(TInPosition)  # Uncomment if needed and installed
library(PTCA4CATA) # Permutation Tests for CATA
library(data4PCCAR) # Example datasets for PCA
library(plyr) # Data manipulation (load first to avoid conflicts)
library(dplyr) # Data manipulation
library(corrplot) # Correlation plots
library(ggplot2) # Data visualization
library(cowplot) # Plot arrangement
library(readr) # Reading data files
library(gridExtra) # Arrange grid-based visualizations
library(grid) # Low-level graphics system
library(here) # Relative file paths
library(psych) # Psychometric tools
library(car)
library(kableExtra)
```


**Data :**  cleaned data, pre processed and grouped into two different datasets - one for RSI measures and other for sociocultural measures from ABCD data.

```{r}
# load datasets
covar_df <- read_csv("/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/covariate.csv")
socio_df <- read_csv("/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/clean-socio.csv")
rsfc_df <- read_csv("/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/clean-rsfc.csv")


fig_dir <- "/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced/figures/"
out_dir <- "/Users/chloehampson/Desktop/abcd-plsc/derivatives/none-reduced"


```

## Performing residualization 

###  MLRM for resting-state data

```{r}
## resting state variables and covariates
# dependent variables
Group1.Y <- as.matrix(rsfc_df)
View(Group1.Y)

# independent variables/covariates
Group1.X <- covar_df
View(Group1.X)
```



```{r}
# Multiple regression model
lm.Group1 <- lm(Group1.Y ~ Group1.X$interview_age +
  as.factor(Group1.X$demo_sex_v2) +
  Group1.X$demo_prnt_age_v2 +
  as.factor(Group1.X$demo_prnt_gender_id_v2) +
  Group1.X$demo_prnt_ed_v2_2yr_l +
  Group1.X$demo_prtnr_ed_v2_2yr_l +
  Group1.X$demo_comb_income_v2 +
  as.factor(Group1.X$demo_origin_v2) +
  as.factor(Group1.X$site_id_l) +
  as.factor(Group1.X$mri_info_manufacturer) +
  Group1.X$rsfmri_meanmotion, na.action = na.omit)


# R.square -> how well the model explains the variation in the data which is not random
# Theorotical model performace is defined as R square

Group1_residuals <- data.frame()
Group1_residuals <- as.data.frame(lm.Group1$residuals)
```

### MLRM for sociocultural data

```{r echo=TRUE}
Group2.Y <- as.matrix(socio_df)


lm.Group2 <- lm(Group2.Y ~ Group1.X$interview_age +
  as.factor(Group1.X$demo_sex_v2) +
  Group1.X$demo_prnt_age_v2 +
  as.factor(Group1.X$demo_prnt_gender_id_v2) +
  Group1.X$demo_prnt_ed_v2_2yr_l +
  Group1.X$demo_prtnr_ed_v2_2yr_l +
  Group1.X$demo_comb_income_v2 +
  as.factor(Group1.X$demo_origin_v2) +
  as.factor(Group1.X$site_id_l) +
  as.factor(Group1.X$mri_info_manufacturer) +
  Group1.X$rsfmri_meanmotion, na.action = na.omit)

# keep if we decide this is how we want to deal with missing data #,na.action = na.omit)
# Run VIF to check for multicollinearity
summary(lm.Group2)

Group2_residuals <- data.frame()
Group2_residuals <- as.data.frame(lm.Group2$residuals)

```


## PLSC Analysis


```{r}
# Input data for PLSC
data1 <- as.data.frame(Group1_residuals)
data2 <- as.data.frame(Group2_residuals)

```



```{r echo=TRUE}
# Extract design variable and ensure it's a factor (nominal)
data.design <- as.factor(covar_df$site_id_l)

# Convert to a matrix for PLSC input
data.design.vec <- as.matrix(data.design)
rownames(data.design.vec) <- covar_df$src_subject_id

# Run PLSC analysis
pls.res <- tepPLS(
  data1,
  data2,
  DESIGN = data.design.vec,
  make_design_nominal = TRUE,
  graphs = FALSE
)

summary(pls.res)
```


```{r}
# generating bar plots for loadings of Air pollutants data table
Q.data2 <- pls.res$TExPosition.Data$pdq$q
# generating bar plots for loadings of RSI data table
P.data1 <- pls.res$TExPosition.Data$pdq$p

# saving the loading table into excel file.
socio_loadings <- as.data.frame(Q.data2)
rest_loadings <- as.data.frame(P.data1)
```
```{r}
# Looking into what the resBootPLSC is giving us
resBoot4PLSC <- Boot4PLSC(data1, # First Data matrix
  data2, # Second Data matrix
  nIter = 10000, # How many iterations
  Fi = pls.res$TExPosition.Data$fi,
  Fj = pls.res$TExPosition.Data$fj,
  nf2keep = 5, #determines number of dimensions that go into bootstrap
  critical.value = 2.5,
  # To be implemented later
  # has no effect currently
  alphaLevel = 0.5
)

resBoot4PLSC

```

```{r}

BR.I <- resBoot4PLSC$bootRatios.i
BR.J <- resBoot4PLSC$bootRatios.j

```

```{r}

# Calculate percent variance explained by each PLSC dimension using the
# bootstrap ratios (sum-of-squares per component). This combines both blocks (I and J)
# so there is one result per dimension showing total bootstrap-ratio variance.
## Sum of squares (per component) for each block
ssq.BR.I <- colSums(BR.I^2)
ssq.BR.J <- colSums(BR.J^2)

## Combined SSQ per component (I + J)
ssq.combined <- ssq.BR.I + ssq.BR.J

## Percent of total combined bootstrap-ratio variance per component
pctVar.combined <- ssq.combined / sum(ssq.combined) * 100

## Cumulative percent
cumVar.combined <- cumsum(pctVar.combined)

## Build human-readable table and save
pct_table_combined <- data.frame(
  Component = paste0("Dim", seq_along(pctVar.combined)),
  SSQ_Brain = round(ssq.BR.I, 6),
  SSQ_Sociocultural = round(ssq.BR.J, 6),
  SSQ_Combined = round(ssq.combined, 6),
  Percent_Variance = round(pctVar.combined, 4),
  Cumulative_Variance = round(cumVar.combined, 4)
)

print("Combined percent variance of bootstrap ratios (Brain + Sociocultural):")
print(pct_table_combined)

write.csv(pct_table_combined, file.path(out_dir, "pctVar_bootstrap_combined.csv"), row.names = FALSE)

```

```{r}

# Reorder BR.J rows according to specified order
desired_order <- c(
  "EIE-Y", "EIC-Y", "HA-Y", "USA-Y", "FS-Y", "FO-Y", "FR-Y",
  "EIE-C", "EIC-C", "HA-C", "USA-C", "FS-C", "FO-C", "FR-C",
  "PD", "CCoh", "CCon", "COI", "NDI", "GGS"
)

BR.J <- BR.J[desired_order, ]

# Debug: Print bootstrap ratios for dimension 1 to check COI and NDI values
print("Bootstrap ratios for Dimension 1 - COI and NDI:")
print(BR.J[c("COI", "NDI"), 1])
print(paste("COI abs value:", abs(BR.J["COI", 1])))
print(paste("NDI abs value:", abs(BR.J["NDI", 1])))
print(paste("COI significant (>=3):", abs(BR.J["COI", 1]) >= 3))
print(paste("NDI significant (>=3):", abs(BR.J["NDI", 1]) >= 3))

```

```{r}

socio_bootstrap <- as.data.frame(BR.J)
rni_bootstrap <- as.data.frame(BR.I)

# Add src_subject_id as first column
socio_res <- cbind.data.frame(src_subject_id = covar_df$src_subject_id, socio_loadings, socio_bootstrap)
rni_res <- cbind.data.frame(src_subject_id = covar_df$src_subject_id, rest_loadings, rni_bootstrap)

write.csv(socio_res, paste(out_dir,
  "rni-sociocult_Q-components.csv",
  sep = "/"
), row.names = FALSE)

write.csv(rni_res, paste(out_dir,
  "rni-brain_P-components.csv",
  sep = "/"
), row.names = FALSE)

# Add src_subject_id to lx and ly base files
lx_with_id <- cbind.data.frame(src_subject_id = covar_df$src_subject_id, pls.res$TExPosition.Data$lx)
ly_with_id <- cbind.data.frame(src_subject_id = covar_df$src_subject_id, pls.res$TExPosition.Data$ly)

write.csv(lx_with_id, paste(out_dir,
  "rniXrsfc_lx-base.csv",
  sep = "/"
), row.names = FALSE)

write.csv(ly_with_id, paste(out_dir,
  "rniXrsfc_ly-base.csv",
  sep = "/"
), row.names = FALSE)

```

```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 1 and 3
for (dim in c(1, 3)) {
  # Save the plot for BR.I
  # Save at 300 dpi: specify physical units (inches) and res = 300.
  # 2000 x 1200 px at 300 dpi = 2000/300 = 6.6667 in, 1200/300 = 4 in
  png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRI_Dim", dim, ".png")), 
    width = 6.667, height = 4, units = "in", res = 300)

  # For brain networks, use black for significant bars and grey for non-significant
  significant_idx <- abs(BR.I[, dim]) >= 3
  cols_I <- ifelse(significant_idx, "black", "grey70")

  plot_BRI <- PrettyBarPlot2(BR.I[, dim],
    threshold = 3,
    font.size = 2,
    ylab = "Bootstrap Ratios",
    color4bar = cols_I,
  ) + ggtitle(paste0("Component ", dim), subtitle = "Brain Networks (RSFC)")

  print(plot_BRI)
  dev.off() # Close the PNG device for BR.I

  cat("✓ Saved bootstrap ratio plot for Brain Networks, Dimension", dim, "\n")
}

```


```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 1 
dim <- 1  # Change this to plot different dimensions

# Define colors for significant variables
dim1_colors <- c(
  "COI" = "#C7B3FB",
  "NDI" = "#E9C1FF"
)

# Create color vector with grey default
build_row_colors <- function(rows, palette, default = "grey70") {
  col_vec <- setNames(rep(default, length(rows)), rows)
  # Only color the bars that are both in our color palette AND exceed the threshold of |3|
  BR_values <- if(identical(rows, rownames(BR.I))) {
    BR.I[, dim]
  } else {
    BR.J[, dim]
  }
  significant_idx <- abs(BR_values) >= 3  # Values >= +3 or <= -3 are significant
  common <- intersect(names(palette), rows[significant_idx])
  col_vec[common] <- palette[common]
  unname(col_vec)
}

# Save the plot for BR.J
# Save at 300 dpi: 2000 x 1200 px equivalent -> 6.667 x 4 in at 300 dpi
png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRJ_Dim", dim, ".png")), 
  width = 6.667, height = 4, units = "in", res = 300)


# Apply colors only to significant bars
cols_J <- build_row_colors(rownames(BR.J), dim1_colors)
  
plot_BRJ <- PrettyBarPlot2(BR.J[, dim],
  threshold = 3,
  font.size = 3.5,
  ylab = "Bootstrap Ratios",
  color4bar = cols_J
) + ggtitle(paste0("Component ", dim), subtitle = "Sociocultural Variables")

# Extract the plot data and manually add a fill layer
plot_data <- data.frame(
  x = 1:nrow(BR.J),
  y = BR.J[, dim],
  fill_color = cols_J
)

plot_BRJ <- plot_BRJ + 
  geom_col(data = plot_data, aes(x = x, y = y), fill = cols_J, color = cols_J)
  
print(plot_BRJ)
dev.off() # Close the PNG device for BR.J
  
cat("✓ Saved bootstrap ratio plots for Dimension", dim, "\n\n")

```


```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 3
dim <- 3  # Change this to plot different dimensions

# Define colors for significant variables for dimension 3
dim3_colors <- c(
  "EIE-C" = "#90CEC1",
  "EIC-C" = "#BCE3C8",
  "HA-C" = "#D2F3D8"
)

# Create color vector with grey default
build_row_colors <- function(rows, palette, default = "grey70") {
  col_vec <- setNames(rep(default, length(rows)), rows)
  # Only color the bars that are both in our color palette AND exceed the threshold of |3|
  BR_values <- if(identical(rows, rownames(BR.I))) {
    BR.I[, dim]
  } else {
    BR.J[, dim]
  }
  significant_idx <- abs(BR_values) >= 3  # Values >= +3 or <= -3 are significant
  common <- intersect(names(palette), rows[significant_idx])
  col_vec[common] <- palette[common]
  unname(col_vec)
}

# Save the plot for BR.J
# Save at 300 dpi: 2000 x 1200 px equivalent -> 6.667 x 4 in at 300 dpi
png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRJ_Dim", dim, ".png")), 
  width = 6.667, height = 4, units = "in", res = 300)

# Apply colors only to significant bars
cols_J <- build_row_colors(rownames(BR.J), dim3_colors)  # Use dim3_colors instead of dim1_colors

  
plot_BRJ <- PrettyBarPlot2(BR.J[, dim],
  threshold = 3,
  font.size = 3.5,
  ylab = "Bootstrap Ratios",
  color4bar = cols_J
) + ggtitle(paste0("Component ", dim), subtitle = "Sociocultural Variables")

# Extract the plot data and manually add a fill layer
plot_data <- data.frame(
  x = 1:nrow(BR.J),
  y = BR.J[, dim],
  fill_color = cols_J
)

plot_BRJ <- plot_BRJ + 
  geom_col(data = plot_data, aes(x = x, y = y), fill = cols_J, color = cols_J)
  
print(plot_BRJ)
dev.off() # Close the PNG device for BR.J
  
cat("✓ Saved bootstrap ratio plots for Dimension", dim, "\n\n")

```

### Color bars here don't work:

```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 1 
dim <- 1  # Change this to plot different dimensions

# Define colors for significant variables
dim1_colors <- c(
  "COI" = "#71C0E7",
  "NDI" = "#9BF1FE"
)

# Create color vector with grey default
build_row_colors <- function(rows, palette, default = "grey70") {
  col_vec <- setNames(rep(default, length(rows)), rows)
  # Only color the bars that are both in our color palette AND exceed the threshold of |3|
  BR_values <- if(identical(rows, rownames(BR.I))) {
    BR.I[, dim]
  } else {
    BR.J[, dim]
  }
  significant_idx <- abs(BR_values) >= 3  # Values >= +3 or <= -3 are significant
  common <- intersect(names(palette), rows[significant_idx])
  col_vec[common] <- palette[common]
  unname(col_vec)
}

# Save the plot for BR.J
# Save at 300 dpi: 2000 x 1200 px equivalent -> 6.667 x 4 in at 300 dpi
png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRJ_Dim", dim, ".png")), 
  width = 6.667, height = 4, units = "in", res = 300)


# Apply colors only to significant bars
cols_J <- build_row_colors(rownames(BR.J), dim1_colors)
  
plot_BRJ <- PrettyBarPlot2(BR.J[, dim],
  threshold = 3,
  font.size = 3.5,
  ylab = "Bootstrap Ratios",
  color4bar = cols_J,
) + ggtitle(paste0("Component ", dim), subtitle = "Sociocultural Variables") 
  
print(plot_BRJ)
dev.off() # Close the PNG device for BR.J
  
cat("✓ Saved bootstrap ratio plots for Dimension", dim, "\n\n")

```


```{r echo=TRUE}
# Bootstrap ratios plots for dimensions 3
dim <- 3  # Change this to plot different dimensions

# Define colors for significant variables for dimension 3
dim3_colors <- c(
  "EIE-C" = "#90CEC1",
  "FO-C" = "#90CEC1",
  "FS-Y" = "#90CEC1",
  "EIC-C" = "#BCE3C8",
  "FR-C" = "#BCE3C8",
  "HA-C" = "#D2F3D8",
  "FR-Y" = "#D2F3D8"
)

# Create color vector with grey default
build_row_colors <- function(rows, palette, default = "grey70") {
  col_vec <- setNames(rep(default, length(rows)), rows)
  # Only color the bars that are both in our color palette AND exceed the threshold of |3|
  BR_values <- if(identical(rows, rownames(BR.I))) {
    BR.I[, dim]
  } else {
    BR.J[, dim]
  }
  significant_idx <- abs(BR_values) >= 3  # Values >= +3 or <= -3 are significant
  common <- intersect(names(palette), rows[significant_idx])
  col_vec[common] <- palette[common]
  unname(col_vec)
}
```

```{r echo=TRUE}
# Save the plot for BR.J
# Save at 300 dpi: 2000 x 1200 px equivalent -> 6.667 x 4 in at 300 dpi
png(file.path(fig_dir, paste0("Bootstrap_Ratio_BRJ_Dim", dim, ".png")), 
  width = 6.667, height = 4, units = "in", res = 300)

# Apply colors only to significant bars
cols_J <- build_row_colors(rownames(BR.J), dim3_colors)  # Use dim3_colors instead of dim1_colors
  
plot_BRJ <- PrettyBarPlot2(BR.J[, dim],
  threshold = 3,
  font.size = 3.5,
  ylab = "Bootstrap Ratios",
  color4bar = cols_J,
  color4ns = "grey70"
) + ggtitle(paste0("Component ", dim), subtitle = "Sociocultural Variables")
  
print(plot_BRJ)
dev.off() # Close the PNG device for BR.J
  
cat("✓ Saved bootstrap ratio plots for Dimension", dim, "\n\n")

```